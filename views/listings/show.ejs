<% layout("/layouts/boilerplate") %>

<div class="container my-5">
  <div class="row justify-content-center">
    <div class="col-lg-9">

      <!-- ================= LISTING CARD ================= -->
      <div class="card shadow-lg border-0 rounded-4 overflow-hidden">

        <!-- IMAGE -->
        <img
          src="<%= listing.image && listing.image.url ? listing.image.url : 'https://via.placeholder.com/1000x500' %>"
          class="card-img-top"
          style="object-fit: cover; max-height: 420px;"
          alt="<%= listing.title %>"
        >

        <div class="card-body p-4">

          <h2 class="fw-bold mb-2"><%= listing.title %></h2>
          <p class="text-muted"><%= listing.description %></p>

          <h4 class="text-success fw-bold">
            ‚Çπ <%= listing.price %> / night
          </h4>

          <p class="mb-3">
            üìç <%= listing.location %>, <%= listing.country %>
          </p>

          <!-- OWNER ACTIONS -->
          <% if (currentUser && listing.owner && listing.owner.toString() === currentUser._id.toString()) { %>
            <div class="d-flex gap-3 mt-3">
              <a href="/listings/<%= listing._id %>/edit" class="btn btn-warning">
                ‚úèÔ∏è Edit
              </a>

              <form method="POST" action="/listings/<%= listing._id %>?_method=DELETE">
                <button class="btn btn-danger">üóë Delete</button>
              </form>
            </div>
          <% } %>

        </div>
      </div>

      <!-- ================= MAP ================= -->
      <div class="mt-5">
        <h4>Where you'll be</h4>

        <div
          id="map"
          data-lat="<%= listing.geometry ? listing.geometry.coordinates[1] : 26.9124 %>"
          data-lng="<%= listing.geometry ? listing.geometry.coordinates[0] : 75.7873 %>"
          style="height:350px;border-radius:12px;"
        ></div>
      </div>

      <!-- ================= REVIEWS ================= -->
      <div class="mt-5">
        <h4>Reviews</h4>

        <% if (!listing.reviews || listing.reviews.length === 0) { %>
          <p class="text-muted">No reviews yet.</p>
        <% } %>

        <ul class="list-group mb-4">
          <% for (let review of listing.reviews) { %>
            <li class="list-group-item">
              <strong>‚≠ê <%= review.rating %>/5</strong>
              <p><%= review.comment %></p>

              <% if (currentUser && review.author && review.author.toString() === currentUser._id.toString()) { %>
                <form method="POST" action="/listings/<%= listing._id %>/reviews/<%= review._id %>?_method=DELETE">
                  <button class="btn btn-sm btn-danger">Delete Review</button>
                </form>
              <% } %>
            </li>
          <% } %>
        </ul>

        <% if (currentUser) { %>
          <form method="POST" action="/listings/<%= listing._id %>/reviews">
            <select name="review[rating]" class="form-select mb-2" required>
              <option value="">Rating</option>
              <option value="1">‚≠ê</option>
              <option value="2">‚≠ê‚≠ê</option>
              <option value="3">‚≠ê‚≠ê‚≠ê</option>
              <option value="4">‚≠ê‚≠ê‚≠ê‚≠ê</option>
              <option value="5">‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê</option>
            </select>

            <textarea name="review[comment]" class="form-control mb-2" required></textarea>
            <button class="btn btn-primary">Submit</button>
          </form>
        <% } else { %>
          <a href="/login">Login to add a review</a>
        <% } %>

      </div>
    </div>
  </div>
</div>

<!-- ================= MAP SCRIPT ================= -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>
  const mapDiv = document.getElementById("map");
  const lat = parseFloat(mapDiv.dataset.lat);
  const lng = parseFloat(mapDiv.dataset.lng);

  const map = L.map("map").setView([lat, lng], 10);

  L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
    attribution: "¬© OpenStreetMap"
  }).addTo(map);

  L.marker([lat, lng]).addTo(map);
</script>
